<!doctype html>

<meta charset="UTF-8">
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

<style>
#conteudo {
    margin: 50px auto;
    width: 960px;
    text-align: center;
}

.centralizar {
    margin: 0 auto;
}

td {
    text-align: center;
    min-width: 90px;
    padding: 10px 0;
}

tbody tr:hover {
    background-color: #f5f5f5;
}

thead td {
    cursor: pointer;
    user-select: none;
    font-weight: bold;
}

</style>

<title>Table Top - DigitalDesk</title>

<div id="conteudo">
    <h1>Ticket to ride</h1>

    <table id="placar" class="centralizar">
        <thead>
            <tr>
                <td ordenacao="nome">Jogador</td>
                <td ordenacao="jogos">Jogos</td>
                <td ordenacao="vitorias">Vit√≥rias</td>
                <td ordenacao="aproveitamento">Aproveitamento</td>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <hr>

    <table id="historico" class="centralizar">
        <thead>
            <tr>
                <td>Data</td>
                <td>Nome</td>
                <td>Pontos</td>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
const ordenador = attr => (a, b) => typeof a[attr] === 'string'
                                ? a[attr] > b[attr]
                                : a[attr] < b[attr]

const historico = [
    {
        data: '27/08/2018',
        resultados: [
            ['Igor', 108],
            ['Gabriel', 115],
            ['Fred', 124]
        ]
    }
]

const gerarPlacar = () => {
    const agregado = new Map()

    for (const jogo of historico) {
        let nomeGanhador = null
        let pontosGanhador = null

        for (const [nome, pontos] of jogo.resultados) {
            if (pontosGanhador === null || pontosGanhador < pontos) {
                pontosGanhador = pontos
                nomeGanhador = nome
            }

            if (!agregado.has(nome)) {
                agregado.set(nome, 0)
            }
        }

        agregado.set(nomeGanhador, agregado.get(nomeGanhador) + 1)
    }

    const jogos = historico.length
    const dados = []

    for (const [nome, vitorias] of agregado.entries()) {
        dados.push({ nome, vitorias, jogos, aproveitamento: vitorias / jogos * 100 })
    }

    return dados
}

const placar = gerarPlacar()

const criarLinha = textosCelulas => {
    const tr = document.createElement('tr')

    textosCelulas.map(texto => {
        const td = document.createElement('td')
        td.textContent = texto
        return td
    }).forEach(tr.appendChild.bind(tr))

    return tr
}

const popularPlacar = placar => {
    const tbody = document.querySelector('#placar tbody')

    for (const x of placar) {
        tbody.appendChild(criarLinha([
            x.nome,
            x.jogos,
            x.vitorias,
            x.aproveitamento.toFixed(2) + '%'
        ]))
    }
}

const popularHistorico = historico => {
    const tbody = document.querySelector('#historico tbody')

    for (const jogo of historico) {
        const resultados = jogo.resultados.sort(ordenador(1))
        let primeira = true
        for (const [nome, pontos] of resultados) {
            if (primeira) {
                const linha = criarLinha([jogo.data, nome, pontos])
                linha.firstElementChild.setAttribute('rowspan', resultados.length)
                tbody.appendChild(linha)
                primeira = false
            } else {
                tbody.appendChild(criarLinha([nome, pontos]))
            }
        }
    }
}

window.addEventListener('load', () => {
    document.querySelectorAll('#placar td').forEach(td => {
        td.addEventListener('click', () => {
            const tbody = document.querySelector('#placar tbody')
            tbody.parentNode.replaceChild(tbody.cloneNode(false), tbody)

            const prop = td.getAttribute('ordenacao')
            popularPlacar(placar.sort(ordenador(prop)))
        })
    })

    popularPlacar(placar.sort(ordenador('vitorias')))

    popularHistorico(historico)
})
</script>
